import sys
from celery import shared_task
from malware_analysis.settings import BASE_DIR
sys.path.append(BASE_DIR)
from clients.yara import YaraClient
from clients.clamav import ClamAvClient
from clients.virustotal import VirusTotalClient
from celery_progress.backend import ProgressRecorder
from utils.functions import get_scanner_configuration
from analyze.models import Files
import logging
import traceback
import time

@shared_task(bind=True)
def scan_files_task(self, obj_pk, file):
    try:
        scanner_conf = get_scanner_configuration()
        sandbox = scanner_conf['sandbox_is_active']
        clamav = scanner_conf['clamav_is_active']
        yara = scanner_conf['yara_is_active']
        progress_recorder = ProgressRecorder(self)
        if not (clamav or yara or sandbox):
            obj = Files.objects.get(id=obj_pk)
            obj.delete()
            raise Exception('At least one of the scanners should be active')
        if sandbox:
            virustotal_client = VirusTotalClient()
            logging.info("Starting sandbox scan...")
            virustotal_client.get_file_report_by_hash(obj_pk, file)
            progress_recorder.set_progress(1,3, description="sandbox scan job finished")
            logging.info("finishing sandbox scan...")
        if clamav:
            clamav_client = ClamAvClient()
            logging.info("Starting clamav scan...")
            clamav_client.scan_file(obj_pk, file)
            progress_recorder.set_progress(3,3, description="clamav scan job finished")
            logging.info("finishing clamav scan...")
        if yara:
            yara_client = YaraClient()
            logging.info("Starting yara scan...")
            yara_client.scanning_files(obj_pk, file)
            progress_recorder.set_progress(2,3, description="yara scan job finished")
            logging.info("finishing yara scan...")
    except:
        logging.error(traceback.format_exc())



    




