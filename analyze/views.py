from rest_framework.viewsets import ModelViewSet
from rest_framework.response import Response
from rest_framework import status
from analyze.models import Files
from analyze.serializers import FileSerializers
from django_filters.rest_framework import DjangoFilterBackend
from django.utils.encoding import smart_str
from malware_analysis import settings
from analyze.tasks import scan_files_task
from analyze.throttles import ConditionalThrottle
from analyze.authenticate import CustomBasicAuthentication
from analyze.permissions import IsOnlyOwner
from utils.functions import get_allowed_files, file_type_detection, CustomException
import base64
import logging
import os
import traceback

class ScanFiles(ModelViewSet):

    queryset = Files.objects.all()
    serializer_class = FileSerializers
    filter_backends = [DjangoFilterBackend]
    filterset_fields = ['file_name','username']
    throttle_classes = [ConditionalThrottle]
    authentication_classes = [CustomBasicAuthentication]
    permission_classes = [IsOnlyOwner]


    def get_queryset(self):
        try:

            auth_header = self.request.headers.get('Authorization')
            auth_type, auth_string = auth_header.split(' ')
            if smart_str(auth_type.lower()) == 'basic':
                decoded_auth_string = base64.b64decode(smart_str(auth_string)).decode('utf-8')
                username, _= decoded_auth_string.split(':')
                queryset = Files.objects.filter(username=username)
                return queryset
            elif smart_str(auth_type.lower()) == 'bearer':
                queryset = Files.objects.all()
                return queryset
        except:
            logging.error(traceback.format_exc())

    def create(self, request, *args, **kwargs):
        try:
            auth_header = self.request.headers.get('Authorization')
            _, auth_string = auth_header.split(' ')
            decoded_auth_string = base64.b64decode(smart_str(auth_string)).decode('utf-8')
            username, password= decoded_auth_string.split(':')
            data = request.data
            transmission_type = data.get('transmission_type')
            file = request.FILES.get('file')
            if file:
                file_name = file.name
                file_size = file.size
                file_content_type = file.content_type
                request_data = {
                    "file": file
                }
                serializer = self.get_serializer(data=request_data)
                if serializer.is_valid():
                    obj = Files(
                        file = file,
                        username = username,
                        file_name = file_name,
                        file_size_in_bytes = file_size,
                        file_content_type = file_content_type,
                        yara_scanner_status = "IN_PROCESS",
                        clamav_scanner_status = "IN_PROCESS",
                        antiviruses_scanner_status = "IN_PROCESS"
                    )
                    obj.save()
                    obj_pk = obj.pk
                    get_file = obj.file.name
                    file_path = os.path.join(settings.BASE_DIR, f"{get_file}")
                    try:
                        allowed_download, allowed_upload = get_allowed_files(username, password)
                        file_type = file_type_detection(file_path)
                    except CustomException as e:
                        if e.status_code ==500:
                            return Response({"error": str(e)}, status.HTTP_500_INTERNAL_SERVER_ERROR)
                        elif e.status_code==400:
                            return Response({"error": str(e)}, status.HTTP_400_BAD_REQUEST)
                    if transmission_type == 'download':
                        if isinstance(file_type, list):
                            existed = any(ext in file_type for ext in allowed_download)
                            if existed:
                                logging.info('file ok for download')
                                pass
                            else:
                                return Response({"error": "you are not permitted to download this type of file"}, status.HTTP_400_BAD_REQUEST)
                        else:
                            if file_type in allowed_download:
                                logging.info('file ok for download')
                                pass
                            else:
                                return Response({"error": "you are not permitted to download this type of file"}, status.HTTP_400_BAD_REQUEST)
                    elif transmission_type == 'upload':
                        if isinstance(file_type, list):    
                            existed = any(ext in file_type for ext in allowed_upload)
                            if existed:
                                logging.info('file ok for download')
                                pass
                            else:
                                return Response({"error": "you are not permitted to download this type of file"}, status.HTTP_400_BAD_REQUEST)
                        else:
                            if file_type in allowed_upload:
                                logging.info('file ok for upload')
                            else:
                                return Response({"error": "you are not permitted to upload this type of file"}, status.HTTP_400_BAD_REQUEST)
                    scan_files_task.delay(obj_pk, file_path)
                    return Response({"info":"scanning files in process"}, status.HTTP_200_OK)
                else:
                    return Response(serializer.errors, status.HTTP_400_BAD_REQUEST)
            else:
                return Response({"error": "file not sent properly"}, status.HTTP_400_BAD_REQUEST)
        except:
            logging.error(traceback.format_exc())
            return Response({"error":"something's wrong"}, status.HTTP_500_INTERNAL_SERVER_ERROR)
