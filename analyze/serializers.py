from rest_framework.serializers import ModelSerializer
from rest_framework import serializers
from analyze.models import Files, UbaReport, MimeTypes, LogServerConfig, Scanners
from django.core.exceptions import ValidationError
from zipfile import ZipFile
from utils.functions import license_profile_endpoint, generate_secure_link
import requests
import json

class FileSerializers(ModelSerializer):

    downloadable_link = serializers.SerializerMethodField("get_downloadable_link")


    class Meta:
        model = Files
        fields = "__all__"

    def get_downloadable_link(self, obj):
        file_path = obj.file.path
        return file_path
    
    def validate_file(self, value):
        file_type = value.content_type
        if file_type == "application/zip":
            zip_file = ZipFile(value)
            file_list = zip_file.filelist
            for _ in file_list:
                file_name = _.filename
                if _.compress_size != 0:
                    file = file_name
                    break
                else:
                    pass
            try:
                zip_file.open(file)
            except Exception as e:
                raise serializers.ValidationError(e)
        else:
            return value


class MaliciousUbaSerializers(ModelSerializer):

    class Meta:
        model = UbaReport
        fields = "__all__"

    def update(self, instance, validated_data):
        is_ban = validated_data['is_ban']
        if is_ban == False:
            instance.malbehave_count = 0
            instance.save()
            return super().update(instance, validated_data)
        return super().update(instance, validated_data)
    

class MimetypesSerializers(ModelSerializer):
    mimetype_list = serializers.ReadOnlyField()
    extension_list = serializers.ReadOnlyField()

    class Meta:
        model = MimeTypes
        fields = "__all__"

class LogServerSerializer(ModelSerializer):

    class Meta:
        model = LogServerConfig
        fields = "__all__"

    def create(self, validated_data):
        if LogServerConfig.objects.exists():
            raise ValidationError("you can just have one server log!")
        return super().create(validated_data)

class ScannerSerializer(ModelSerializer):


    # id = serializers.SerializerMethodField('get_id')

    class Meta:
        model = Scanners
        fields = "__all__"


    # def get_id(self, obj):
    #     id = obj.pk
    #     return id 

    def create(self, validated_data):
        if Scanners.objects.exists():
            raise serializers.ValidationError({"error":"you can just have one scanner config"})
        sandbox_is_active = validated_data.get('sandbox_is_active', False)
        validated_data.pop('clamav_is_active')
        if sandbox_is_active:
            uri, url = license_profile_endpoint()
            encoded_hash, expiry = generate_secure_link(uri)
            license_profile = url + f"&md5={encoded_hash}" + f"&expires={expiry}"
            request = requests.get(license_profile)
            if request.status_code == 200:
                response = json.loads(request.content)
                valid_license = response['valid_license']
                if not valid_license:
                    raise serializers.ValidationError({"error":"set sandbox to false or purchase sandbox license"})
            elif request.status_code == 404:
                raise serializers.ValidationError({"error":"set sandbox to false or purchase sandbox license"})
        return Scanners.objects.create(**validated_data)

    def update(self, instance, validated_data):
        sandbox_is_active = validated_data.get('sandbox_is_active', False)
        validated_data.pop('clamav_is_active')
        if sandbox_is_active:
            uri, url = license_profile_endpoint()
            encoded_hash, expiry = generate_secure_link(uri)
            license_profile = url + f"&md5={encoded_hash}" + f"&expires={expiry}"
            request = requests.get(license_profile)
            if request.status_code == 200:
                response = json.loads(request.content)
                valid_license = response['valid_license']
                if not valid_license:
                    raise serializers.ValidationError({"error":"set sandbox to false or purchase sandbox license"})
            elif request.status_code == 404:
                raise serializers.ValidationError({"error":"set sandbox to false or purchase sandbox license"})
        return super().update(instance, validated_data)
        


