from analyze.models import Files
from malware_analysis.settings import BASE_DIR
import yara
import logging
import traceback
import sys 

yara_rules_path = str(BASE_DIR)+"/yara_rules"
sys.path.append(yara_rules_path)

class YaraClient():


    def scanning_files(self, obj_pk, file):
        try:
            obj = Files.objects.get(id=obj_pk)
            matched_rules = []
            result = {}
            yara_rule = yara.compile(f"{BASE_DIR}/yara_rules/index.yar", includes=True)
            matches = yara_rule.match(file)
            if matches:
                logging.info("file is malicious")
                for match in matches:
                    logging.info(f"matched rule : {match}")
                    matched_rules.append(match)
            else:
                logging.info("file is not malicious")
            result["matched_rules"] = matched_rules
            if not result["matched_rules"]:
                obj.yara_scanner_status = "FINISHED"
                obj.yara_scan_summary  = "yara did not find any virus for this file"
                obj.yara_scan_result = False
                obj.save()
            else:                
                obj.yara_scanner_status = "FINISHED"
                obj.yara_scan_summary = result
                obj.yara_scan_result = True
                obj.save()
        except:
            yara_error_message = logging.error(traceback.format_exc())
            obj.yara_error_message = yara_error_message
            obj.yara_scanner_status = "FAILED"
            obj.save()
