from analyze.models import Files
import subprocess as sp
import re


class ClamAvClient():


    def scan_file(self, obj_pk, file):
        obj = Files.objects.get(id=obj_pk)
        Command = ['sudo', 'clamscan', f"{file}"]
        proc = sp.Popen(Command, stdout=sp.PIPE, stderr=sp.PIPE)
        stdout, stderr = proc.communicate()
        if stderr:
            error_message = {"error": stderr.decode()}
            obj.clamav_error_message = error_message
            obj.save()
        output = stdout.decode()
        pattern = r'(.+):\s*(.+)\s+FOUND'
        match = re.search(pattern, output)
        if match:
            infected_file = match.group(1)
            virus_name = match.group(2)
            obj.clamav_scan_summary = virus_name
            obj.clamav_scan_result = True
            obj.clamav_scanner_status = "FINISHED"
            obj.save()
        else:
            obj.clamav_scan_summary = "clamav did not find any viruses for this file"
            obj.clamav_scan_result = False
            obj.clamav_scanner_status = "FINISHED"
            obj.save()
        message = "clamav scan finished"
        return message
    